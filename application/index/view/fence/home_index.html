{layout name="layout" /}
<!-- content start -->
<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak={$ak}"></script>
<div class="admin-content">

    <div class="am-cf am-padding">
        <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">首页</strong> /
            <small>电子围栏信息</small>
        </div>
    </div>

    <div class="am-g">
        <div class="am-u-md-12">
            <div class="am-g" style="margin-bottom: 10px">
                <div class="am-u-md-2" style="text-align: right;">
                    <span>电子围栏：</span>
                </div>
                <div class="am-u-md-4" style="text-align: left;">
                    {:token('token')}
                    <select name="fence" id="fence" onchange="changeFence()" data-am-selected>
                        {volist name="fenceNames" id ="fenceName"}
                        <option value="{$fenceName.id}" {if condition="$nowFence.id eq $fenceName.id" } selected {/if}>{$fenceName.name}</option>
                        {/volist}
                    </select>
                </div>
                <div class="am-u-md-6"></div>
            </div>

            <div class="am-g">
                <div id="allmap" style="height:500px; width: 100%;"></div>
            </div>
        </div>
    </div>


</div>
<!-- content end -->
<script type="text/javascript">
    // 百度地图API功能
    var submitUrl = "<?php echo url('index/fence/homeIndex') ?>";
    var map = new BMap.Map("allmap");
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);
    map.enableScrollWheelZoom();
    var nowPolygon;

    var opts = {
        width: 250,     // 信息窗口宽度
        height: 150,     // 信息窗口高度
        title: "车辆信息", // 信息窗口标题
        enableMessage: true//设置允许信息窗发送短息
    };

    const renderPolygon = function (mapObj, points) {
        var mapPoint = [];
        points.forEach(item => {
            mapPoint.push(new BMap.Point(item.lng, item.lat));
        });
        var polygon = new BMap.Polygon(mapPoint, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});  //创建多边形
        if (nowPolygon) {
            mapObj.removeOverlay(nowPolygon);
        }
        nowPolygon = polygon;
        mapObj.addOverlay(polygon);
        map.centerAndZoom(mapPoint[0], 16);
    };

    const addClickHandler = function (content, marker) {
        marker.addEventListener("click", function (e) {
                openInfo(content, e)
            }
        );
    };

    const openInfo = function (content, e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    };

    const renderBicycles = function (mapObj, bicycles) {
        for (var i = 0; i < bicycles.length; i++) {
            var pt = new BMap.Point(bicycles[i].gps.lng, bicycles[i].gps.lat);
            var myIcon = new BMap.Icon("http://sharebicycle.yihengjie.cn/static/img/bicycle.png", new BMap.Size(15, 15));
            var marker = new BMap.Marker(pt, {icon: myIcon});  // 创建标注

            var content = "车名:" + bicycles[i].bicycle_name + "<br/>" +
                    "车号:" + bicycles[i].bicycle_number + "<br/>" +
                    "锁IMEI:" + bicycles[i].lock_number + "<br />" +
                    "每小时价格:" + bicycles[i].hourlyPrice + "<br />" +
                    "每天价格:" + bicycles[i].dailyPrice + "<br />" ;
            mapObj.addOverlay(marker);               // 将标注添加到地图中
            addClickHandler(content, marker);
        }
    };

    //init first
    renderPolygon(map, JSON.parse('<?php echo $nowFence->points; ?>'));

    renderBicycles(map, JSON.parse('<?php echo $nowFenceBiycles ?>'));

    const changeFence = function () {
        $.ajax({
            url: submitUrl,
            type: 'post',
            dataType: 'json',
            timeout: 5000,
            async: true,   // 是否异步
            data: {
                'token': $("input[name='token']").val(),
                'fence_id': $('#fence').val()
            },
            success: function (data, status) {
                var responseStatus = data.status;
                if (!responseStatus) {
                    renderPolygon(map, JSON.parse(data.data.nowFence.points));
                    renderBicycles(map, data.data.bicycles);
                } else {
                    alertErrMsg(responseStatus, data.msg);
                }
            },
            fail: function (err, status) {
                console.log(err)
            }
        })
    };


</script>

