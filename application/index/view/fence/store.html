<style type="text/css">
    #allmap {width: 100%; height:500px; overflow: hidden;}
</style>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak={$ak}"></script>
<!--加载鼠标绘制工具-->
<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
<!--加载检索信息窗口-->
<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css" />

<!--<div id="result">-->
    <!--<input type="button" value="显示经纬度" onclick="console.log(overlays)"/>-->
    <!--<input type="button" value="清除所有覆盖物" onclick="clearAll()"/>-->
<!--</div>-->

<div class="admin-content">
    <div class="am-cf am-padding">
        <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">电子围栏管理</strong> /
            <small>新增</small>
        </div>
    </div>

    <div class="am-tabs am-margin" data-am-tabs>
        <ul class="am-tabs-nav am-nav am-nav-tabs">
            <li><a href="#tab2">请绘制电子围栏范围</a></li>
        </ul>

        <div class="am-tabs-bd">
            <div class="am-tab-panel am-fade" id="tab2">
                <form class="am-form" name="storeClient">
                    {:token('token')}
                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-2 am-text-right">
                            关联车辆
                        </div>
                        <div class="am-u-sm-4">
                            <select name="person" id="person">
                                <option value="">--请选择--</option>
                                {volist name="persons" id="person"}
                                    <option value="{$person.id}">{$person.bicycle_name}</option>
                                {/volist}
                            </select>
                        </div>
                        <div class="am-u-sm-6">*必填</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div id="allmap" style="overflow:hidden;zoom:1;position:relative;">
                            <div id="map" style="height:100%;-webkit-transition: all 0.5s ease-in-out;transition: all 0.5s ease-in-out;"></div>
                        </div>
                    </div>

                </form>
            </div>

        </div>
    </div>

    <div class="am-margin">
        <button type="button" class="am-btn am-btn-primary am-btn-xs" id="formSubmit">提交保存</button>
        <button type="button" class="am-btn am-btn-primary am-btn-xs" id="formReset">放弃保存</button>

    </div>
</div>


<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map('map');
    var poi = new BMap.Point(116.307852,40.057031);
    map.centerAndZoom(poi, 15);
    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function(r){
        if(this.getStatus() == BMAP_STATUS_SUCCESS){
            map.panTo(r.point);
        }
        else {
            alert('failed'+this.getStatus());
        }
    },{enableHighAccuracy: true});

    map.enableScrollWheelZoom();
    var overlays = [];
    var fencesNames = [];

    var overlaycomplete = function(e){
        overlays.push(e.overlay);
        var name = prompt("请为您刚刚绘制的电子围栏取个名称！");
        if (!name) {
            map.removeOverlay(overlays[overlays.length - 1]);   //不输入名字就不保存电子围栏
        } else {
            fencesNames.push(name)
        }
    };

    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(5, 5), //偏离值
            drawingModes: [BMAP_DRAWING_POLYGON]    //设置绘制工具栏 多边形绘制
        }
    });

    //添加鼠标绘制工具监听事件，用于获取绘制结果
    drawingManager.addEventListener('overlaycomplete', overlaycomplete);
    function clearAll() {
        for(var i = 0; i < overlays.length; i++){
            map.removeOverlay(overlays[i]);
        }
        overlays.length = 0
    }


    //页面处理逻辑
    const submitUrl = "<?php echo url('index/fence/store') ?>";
    const formReset = function () {
        clearAll()  //清除所有围栏
    };

    const formSubmit = function () {
        var pointData = [];
        overlays.forEach(function (item) {
            var temp = item.ja;
            temp.pop();
           pointData.push(temp);
        });
        $.ajax({
            url: submitUrl,
            type: 'post',
            dataType: 'json',
            timeout: 5000,
            async: true,   // 是否异步
            data: {
                'token': $("input[name='token']").val(),
                'data': JSON.stringify(pointData),
                'names': JSON.stringify(fencesNames),
                'person': $("#person").val()
            },
            success: function (data, status) {
                var responseStatus = data.status;
                if (!responseStatus) {
                    alertSuccessMsg(responseStatus, "<?php echo url('index/fence/index') ; ?>");
                } else {
                    alertErrMsg(responseStatus, data.msg);
                }
            },
            fail: function (err, status) {
                console.log(err)
            }
        })
    };

    $('#formReset').click(formReset);
    $('#formSubmit').click(formSubmit);
</script>

