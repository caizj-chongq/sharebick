<style type="text/css">
    #allmap {width: 100%; height:500px; overflow: hidden;}
</style>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak={$ak}"></script>
<!--加载鼠标绘制工具-->
<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
<!--加载检索信息窗口-->
<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css" />

<!-- content start -->
<div class="admin-content">

    <div class="am-cf am-padding">
        <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">电子围栏管理</strong> /
            <small>详情</small>
        </div>
    </div>

    <div class="am-tabs am-margin" data-am-tabs>
        <ul class="am-tabs-nav am-nav am-nav-tabs">
            <li><a href="#tab2">电子围栏基本信息</a></li>
        </ul>

        <div class="am-tabs-bd">
            <div class="am-tab-panel am-fade" id="tab2">
                <form class="am-form">

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-2 am-text-right">
                            围栏名称
                        </div>
                        <div class="am-u-sm-4">
                            <input type="text" class="am-input-sm" name="bicycle_number" id="bicycle_number" maxlength="20" required value="{$fenceInfo.name}" readonly>
                        </div>
                        <div class="am-u-sm-6"></div>
                    </div>

                    <div class="am-g am-margin-top" id="points" points="{$fenceInfo.points}">
                        <div id="allmap"></div>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>
<!-- content end -->

<script type="text/javascript">
    // 百度地图API功能
    var points = {$fenceInfo.points};
    var map = new BMap.Map("allmap");
    map.enableScrollWheelZoom();

    var opts = {
        width: 250,     // 信息窗口宽度
        height: 150,     // 信息窗口高度
        title: "车辆信息", // 信息窗口标题
        enableMessage: true//设置允许信息窗发送短息
    };

    const renderPolygon = function (mapObj, points) {
        var mapPoint = [];
        points.forEach(item => {
            mapPoint.push(new BMap.Point(item.lng, item.lat));
        });
        var polygon = new BMap.Polygon(mapPoint, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});  //创建多边形
        mapObj.addOverlay(polygon);
        map.centerAndZoom(mapPoint[0], 16);
    };

    const addClickHandler = function (content, marker) {
        marker.addEventListener("click", function (e) {
                openInfo(content, e)
            }
        );
    };

    const openInfo = function (content, e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    };

    const renderBicycles = function (mapObj, bicycles) {
        for (var i = 0; i < bicycles.length; i++) {
            var pt = new BMap.Point(bicycles[i].gps.lng, bicycles[i].gps.lat);
            var myIcon = new BMap.Icon("http://sharebicycle.yihengjie.cn/static/img/bicycle.png", new BMap.Size(15, 15));
            var marker = new BMap.Marker(pt, {icon: myIcon});  // 创建标注

            var content = "车名:" + bicycles[i].bicycle_name + "<br/>" +
                "车号:" + bicycles[i].bicycle_number + "<br/>" +
                "锁IMEI:" + bicycles[i].lock_number + "<br />" +
                "每小时价格:" + bicycles[i].hourlyPrice + "<br />" +
                "每天价格:" + bicycles[i].dailyPrice + "<br />" ;
            mapObj.addOverlay(marker);               // 将标注添加到地图中
            addClickHandler(content, marker);
        }
    };

    renderPolygon(map, points);
    renderBicycles(map, JSON.parse('<?php echo $bicycles;?>'));
</script>
